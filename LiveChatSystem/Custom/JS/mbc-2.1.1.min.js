var $jscomp={scope:{},findInternal:function(b,a,v){b instanceof String&&(b=String(b));for(var g=b.length,w=0;w<g;w++){var B=b[w];if(a.call(v,B,w,b))return{i:w,v:B}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,v){if(v.get||v.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[a]=v.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,a,v,g){if(a){v=$jscomp.global;b=b.split(".");for(g=0;g<b.length-1;g++){var w=b[g];w in v||(v[w]={});v=v[w]}b=b[b.length-1];g=v[b];a=a(g);a!=g&&null!=a&&$jscomp.defineProperty(v,b,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");$jscomp.polyfill("Math.sign",function(b){return b?b:function(a){a=Number(a);return 0===a||isNaN(a)?a:0<a?1:-1}},"es6-impl","es3");
$jscomp.polyfill("Array.prototype.fill",function(b){return b?b:function(a,b,g){var v=this.length||0;0>b&&(b=Math.max(0,v+b));if(null==g||g>v)g=v;g=Number(g);0>g&&(g=Math.max(0,v+g));for(b=Number(b||0);b<g;b++)this[b]=a;return this}},"es6-impl","es3");var kUtil=kUtil||{};Math.sign||(Math.sign=function(b){return 0<b?1:0==b?0>1/b?-0:0:0>b?-1:NaN});kUtil.Matrix=function(b,a,v,g,w,B){this.a=b;this.b=a;this.c=v;this.d=g;this.e=w;this.f=B};
kUtil.Matrix.dot=function(b,a){return new kUtil.Matrix(b.a*a.a+b.c*a.b,b.b*a.a+b.d*a.b,b.a*a.c+b.c*a.d,b.b*a.c+b.d*a.d,b.a*a.e+b.c*a.f+b.e,b.b*a.e+b.d*a.f+b.f)};kUtil.Matrix.prototype.dot=function(b){return kUtil.Matrix.dot(this,b)};kUtil.Matrix.equals=function(b,a){return b.a==a.a&&b.b==a.b&&b.c==a.c&&b.d==a.d&&b.e==a.e&&b.f==a.f};kUtil.Matrix.prototype.equals=function(b){return kUtil.Matrix.equals(this,b)};
kUtil.Matrix.prototype.inversion=function(){var b=this.a,a=this.b,v=this.c,g=this.d,w=this.e,B=this.f,J=b*g-a*v;return new kUtil.Matrix(g/J,-a/J,-v/J,b/J,(v*B-g*w)/J,(a*w-b*B)/J)};kUtil.convertURLToBlob=function(b,a){var v=new XMLHttpRequest;v.open("GET",b,!0);v.responseType="blob";v.onloadend=function(b){a(this.response)};v.send()};kUtil.convertBase64ToBlob=function(b,a){for(var v=atob(b),g=Array(v.length),w=0;w<v.length;++w)g[w]=v.charCodeAt(w);v=new Uint8Array(g);return new Blob([v],{type:a})};
(function(b){b.fn.borderWidth=function(){var a;a=window.getComputedStyle?getComputedStyle(this[0]):this[0].currentStyle;var b={};b.left=parseFloat(a.getPropertyValue?a.getPropertyValue("border-left-width"):a.getAttribute("border-left-width"))||0;b.top=parseFloat(a.getPropertyValue?a.getPropertyValue("border-top-width"):a.getAttribute("border-top-width"))||0;b.right=parseFloat(a.getPropertyValue?a.getPropertyValue("border-right-width"):a.getAttribute("border-right-width"))||0;b.bottom=parseFloat(a.getPropertyValue?
a.getPropertyValue("border-bottom-width"):a.getAttribute("border-bottom-width"))||0;return b};b.fn.padding=function(){var a;a=window.getComputedStyle?getComputedStyle(this[0]):this[0].currentStyle;var b={};b.left=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-left"):a.getAttribute("padding-left"))||0;b.top=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-top"):a.getAttribute("padding-top"))||0;b.right=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-right"):a.getAttribute("padding-right"))||
0;b.bottom=parseFloat(a.getPropertyValue?a.getPropertyValue("padding-bottom"):a.getAttribute("padding-bottom"))||0;return b};b.fn.borderBoxRect=function(){var a=null;window.getComputedStyle&&(a=getComputedStyle(this[0]));var b=this.offset(),g={};g.pageX0=b.left;g.pageY0=b.top;g.width=a?parseFloat(a.width):this.outerWidth();g.height=a?parseFloat(a.height):this.outerHeight();g.pageX1=g.pageX0+g.width;g.pageY1=g.pageY0+g.height;return g};b.fn.paddingBoxRect=function(){var a=this.borderBoxRect(),b=this.borderWidth(),
g={};g.pageX0=a.pageX0+b.left;g.pageY0=a.pageY0+b.top;g.width=window.getComputedStyle?a.width-(b.left+b.right):this.innerWidth();g.height=window.getComputedStyle?a.height-(b.top+b.bottom):this.innerHeight();g.pageX1=a.pageX1-b.right;g.pageY1=a.pageY1-b.bottom;return g};b.fn.contentBoxRect=function(){var a=this.paddingBoxRect(),b=this.padding(),g={};g.pageX0=a.pageX0+b.left;g.pageY0=a.pageY0+b.top;g.width=window.getComputedStyle?a.width-(b.left+b.right):this.width();g.height=window.getComputedStyle?
a.height-(b.top+b.bottom):this.height();g.pageX1=a.pageX1-b.right;g.pageY1=a.pageY1-b.bottom;return g};b.fn.getTransform=function(){var a=this.css("transform");if("none"==a||""==a)a=this[0].style.transform;var b="matrix(",g=a.indexOf(b);if(-1!=g){g+=b.length;a=a.substring(g,a.indexOf(")",g)).split(",");for(b=0;b<a.length;++b)a[b]=parseFloat(a[b]);return new kUtil.Matrix(a[0],a[1],a[2],a[3],a[4],a[5])}b="scale(";g=a.indexOf(b);return-1!=g?(g+=b.length,a=parseFloat(a.substring(g)),new kUtil.Matrix(a,
0,0,a,0,0)):new kUtil.Matrix(1,0,0,1,0,0)};b.fn.setTransform=function(a){a="matrix("+[a.a,a.b,a.c,a.d,a.e,a.f].join()+")";this.css("transform",a)}})(jQuery);var TaskQueue=function(){this._queue=[];this.isWorking=!1;this.timeout=100};TaskQueue.prototype.push=function(b,a,v){this._queue.push({task:b,context:a,args:v});this.isWorking||this.next()};TaskQueue.prototype.unshift=function(b,a,v){this._queue.unshift({task:b,context:a,args:v});this.isWorking||this.next()};
TaskQueue.prototype.next=function(){if(0==this._queue.length)this.isWorking=!1;else{this.isWorking=!0;var b=this._queue.shift(),a=b.task,v=b.context?b.context:self,g=b.args?b.args:[];setTimeout(function(){a.apply(v,g)},this.timeout)}};
(function(){function b(a,b){b||a.match(/^data\:([^\;]+)\;base64,/mi);a=a.replace(/^data\:([^\;]+)\;base64,/gmi,"");for(var m=atob(a),c=m.length,n=new ArrayBuffer(c),g=new Uint8Array(n),y=0;y<c;y++)g[y]=m.charCodeAt(y);return n}function a(a,b){var m=new XMLHttpRequest;m.open("GET",a,!0);m.responseType="blob";m.onload=function(a){200!=this.status&&0!==this.status||b(this.response)};m.send()}function v(m,c){function n(a){var b=g(a),y;a:if(y=new DataView(a),255!=y.getUint8(0)||216!=y.getUint8(1))y=!1;
else{for(var n=2,A=a.byteLength;n<A;){var d=y,x=n;if(56===d.getUint8(x)&&66===d.getUint8(x+1)&&73===d.getUint8(x+2)&&77===d.getUint8(x+3)&&4===d.getUint8(x+4)&&4===d.getUint8(x+5)){d=y.getUint8(n+7);0!==d%2&&(d+=1);0===d&&(d=4);var A=n+8+d,n=y.getUint16(n+6+d),K,v;y=A;A=new DataView(a);d={};for(x=y;x<y+n;)28===A.getUint8(x)&&2===A.getUint8(x+1)&&(K=A.getUint8(x+2),K in T&&(v=A.getInt16(x+3),K=T[K],v=J(A,x+5,v),d.hasOwnProperty(K)?d[K]instanceof Array?d[K].push(v):d[K]=[d[K],v]:d[K]=v)),x++;y=d;break a}n++}y=
void 0}var B;a:if("DOMParser"in self)if(n=new DataView(a),255!=n.getUint8(0)||216!=n.getUint8(1))B=!1;else{A=2;d=a.byteLength;for(a=new DOMParser;A<d-4;)if("http"==J(n,A,4)){d=A-1;A=n.getUint16(A-2)-1;n=J(n,d,A);A=n.indexOf("xmpmeta>")+8;n=n.substring(n.indexOf("<x:xmpmeta"),A);A=n.indexOf("x:xmpmeta")+10;n=n.slice(0,A)+'xmlns:Iptc4xmpCore="http://iptc.org/std/Iptc4xmpCore/1.0/xmlns/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tiff="http://ns.adobe.com/tiff/1.0/" xmlns:plus="http://schemas.android.com/apk/lib/com.google.android.gms.plus" xmlns:ext="http://www.gettyimages.com/xsltExtension/1.0" xmlns:exif="http://ns.adobe.com/exif/1.0/" xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#" xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#" xmlns:crs="http://ns.adobe.com/camera-raw-settings/1.0/" xmlns:xapGImg="http://ns.adobe.com/xap/1.0/g/img/" xmlns:Iptc4xmpExt="http://iptc.org/std/Iptc4xmpExt/2008-02-29/" '+
n.slice(A);b:{a=a.parseFromString(n,"text/xml");try{n={};if(0<a.children.length)for(A=0;A<a.children.length;A++){var z=a.children.item(A),R=z.attributes,u;for(u in R){var D=R[u],k=D.nodeName,q=D.nodeValue;void 0!==k&&(n[k]=q)}var p=z.nodeName;if("undefined"==typeof n[p])n[p]=xml2json(z);else{if("undefined"==typeof n[p].push){var e=n[p];n[p]=[];n[p].push(e)}n[p].push(xml2json(z))}}else n=a.textContent;B=n;break b}catch(l){console.log(l.message)}B=void 0}break a}else A++;B=void 0}else B=void 0;m.exifdata=
b||{};m.iptcdata=y||{};m.xmpdata=B||{};c&&c.call(m)}if(m.src)if(/^data\:/i.test(m.src)){var d=b(m.src);n(d)}else if(/^blob\:/i.test(m.src)){var x=new FileReader;x.onload=function(a){n(a.target.result)};a(m.src,function(a){x.readAsArrayBuffer(a)})}else{var A=new XMLHttpRequest;A.onload=function(){if(200==this.status||0===this.status)n(A.response);else throw"Could not load image";A=null};A.open("GET",m.src,!0);A.responseType="arraybuffer";A.send(null)}else self.FileReader&&(m instanceof self.Blob||
m instanceof self.File)&&(x=new FileReader,x.onload=function(a){n(a.target.result)},x.readAsArrayBuffer(m))}function g(a){var b=new DataView(a);if(255!=b.getUint8(0)||216!=b.getUint8(1))return!1;var m=2;a=a.byteLength;for(var c;m<a;){if(255!=b.getUint8(m))return!1;c=b.getUint8(m+1);if(225==c)return D(b,m+4,b.getUint16(m+2)-2);m+=2+b.getUint16(m+2)}}function w(a,b,c,d,x){var m=a.getUint16(c,!x),n={},t,H,g;for(g=0;g<m;g++)t=c+12*g+2,H=d[a.getUint16(t,!x)],n[H]=B(a,t,b,c,x);return n}function B(a,b,c,
d,x){var m=a.getUint16(b+2,!x);d=a.getUint32(b+4,!x);c=a.getUint32(b+8,!x)+c;var y,t;switch(m){case 1:case 7:if(1==d)return a.getUint8(b+8,!x);c=4<d?c:b+8;b=[];for(m=0;m<d;m++)b[m]=a.getUint8(c+m);return b;case 2:return J(a,4<d?c:b+8,d-1);case 3:if(1==d)return a.getUint16(b+8,!x);c=2<d?c:b+8;b=[];for(m=0;m<d;m++)b[m]=a.getUint16(c+2*m,!x);return b;case 4:if(1==d)return a.getUint32(b+8,!x);b=[];for(m=0;m<d;m++)b[m]=a.getUint32(c+4*m,!x);return b;case 5:if(1==d)return y=a.getUint32(c,!x),t=a.getUint32(c+
4,!x),a=new Number(y/t),a.numerator=y,a.denominator=t,a;b=[];for(m=0;m<d;m++)y=a.getUint32(c+8*m,!x),t=a.getUint32(c+4+8*m,!x),b[m]=new Number(y/t),b[m].numerator=y,b[m].denominator=t;return b;case 9:if(1==d)return a.getInt32(b+8,!x);b=[];for(m=0;m<d;m++)b[m]=a.getInt32(c+4*m,!x);return b;case 10:if(1==d)return a.getInt32(c,!x)/a.getInt32(c+4,!x);b=[];for(m=0;m<d;m++)b[m]=a.getInt32(c+8*m,!x)/a.getInt32(c+4+8*m,!x);return b}}function J(a,b,c){for(var m="",d=b;d<b+c;d++)m+=String.fromCharCode(a.getUint8(d));
return m}function D(a,b){if("Exif"!=J(a,b,4))return!1;var c,m,n,g,y=b+6;if(18761==a.getUint16(y))c=!1;else if(19789==a.getUint16(y))c=!0;else return!1;if(42!=a.getUint16(y+2,!c))return!1;var t=a.getUint32(y+4,!c);if(8>t)return!1;m=w(a,y,y+t,d,c);if(m.ExifIFDPointer)for(n in g=w(a,y,y+m.ExifIFDPointer,z,c),g){switch(n){case "LightSource":case "Flash":case "MeteringMode":case "ExposureProgram":case "SensingMethod":case "SceneCaptureType":case "SceneType":case "CustomRendered":case "WhiteBalance":case "GainControl":case "Contrast":case "Saturation":case "Sharpness":case "SubjectDistanceRange":case "FileSource":g[n]=
E[n][g[n]];break;case "ExifVersion":case "FlashpixVersion":g[n]=String.fromCharCode(g[n][0],g[n][1],g[n][2],g[n][3]);break;case "ComponentsConfiguration":g[n]=E.Components[g[n][0]]+E.Components[g[n][1]]+E.Components[g[n][2]]+E.Components[g[n][3]]}m[n]=g[n]}if(m.GPSInfoIFDPointer)for(n in g=w(a,y,y+m.GPSInfoIFDPointer,F,c),g){switch(n){case "GPSVersionID":g[n]=g[n][0]+"."+g[n][1]+"."+g[n][2]+"."+g[n][3]}m[n]=g[n]}t=y+t;n=a.getUint16(t,!c);if(t=a.getUint32(t+2+12*n,!c))if(t>a.byteLength)y={};else{t=
w(a,y,y+t,u,c);if(t.Compression)switch(t.Compression){case 6:t.JpegIFOffset&&t.JpegIFByteCount&&(t.blob=new Blob([new Uint8Array(a.buffer,y+t.JpegIFOffset,t.JpegIFByteCount)],{type:"image/jpeg"}));break;case 1:console.log("Thumbnail image format is TIFF, which is not implemented.");break;default:console.log("Unknown thumbnail image format '%s'",t.Compression)}else 2==t.PhotometricInterpretation&&console.log("Thumbnail image format is RGB, which is not implemented.");y=t}else y={};m.thumbnail=y;return m}
var c=function(a){if(a instanceof c)return a;if(!(this instanceof c))return new c(a);this.EXIFwrapped=a};"undefined"!==typeof exports?("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports.EXIF=c):this.EXIF=c;var z=c.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",
36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",
41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",
42016:"ImageUniqueID"},d=c.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",
301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},F=c.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",
16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},u=c.IFD1Tags={256:"ImageWidth",257:"ImageHeight",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",
278:"RowsPerStrip",279:"StripByteCounts",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",296:"ResolutionUnit",513:"JpegIFOffset",514:"JpegIFByteCount",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite"},E=c.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",
2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",
24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",
32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",
95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},
GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}},T={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",
105:"headline",116:"copyright",15:"category"};c.getData=function(a,b){if((self.Image&&a instanceof self.Image||self.HTMLImageElement&&a instanceof self.HTMLImageElement)&&!a.complete)return!1;a.exifdata?b&&b.call(a):v(a,b);return!0};c.getTag=function(a,b){if(a.exifdata)return a.exifdata[b]};c.getIptcTag=function(a,b){if(a.exifdata)return a.iptcdata[b]};c.getAllTags=function(a){if(!a.exifdata)return{};var b;a=a.exifdata;var c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};c.getAllIptcTags=
function(a){if(!a.exifdata)return{};var b;a=a.iptcdata;var c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};c.pretty=function(a){if(!a.exifdata)return"";var b;a=a.exifdata;var c="";for(b in a)a.hasOwnProperty(b)&&(c="object"==typeof a[b]?a[b]instanceof Number?c+(b+" : "+a[b]+" ["+a[b].numerator+"/"+a[b].denominator+"]\r\n"):c+(b+" : ["+a[b].length+" values]\r\n"):c+(b+" : "+a[b]+"\r\n"));return c};c.readFromBinaryFile=function(a){return g(a)};"function"===typeof define&&define.amd&&define("exif-js",
[],function(){return c})}).call(this);
var KPainter=function(b){var a=this;b=b||{};KPainter.xxx="mouse"==b.gesturer?!1:"touch"==b.gesturer?!0:"ontouchend"in document?!0:!1;var v=function(a,b,c,d){a.toBlob?a.toBlob(b,c,d):(a=a.toDataURL(c,d),c=kUtil.convertBase64ToBlob(a.substring(a.indexOf(",")+1),c),b(c))},g=function(a,b){b=b||new kUtil.Matrix(1,0,0,1,0,0);var c=document.createElement("canvas");0!=b.a*b.d&&0==b.b*b.c?(c.width=a.naturalWidth||a.width,c.height=a.naturalHeight||a.height):(c.width=a.naturalHeight||a.height,c.height=a.naturalWidth||
a.width);var t=c.getContext("2d");t.setTransform(b.a,b.b,b.c,b.d,b.e*c.width,b.f*c.height);t.drawImage(a,0,0);return c},w=function(a,b,c){var t=function(){var t=URL.createObjectURL(a),d=new Image;d.onload=d.onerror=function(){d.onload=d.onerror=null;var a=g(d,b);URL.revokeObjectURL(t);c(a)};d.src=t};window.createImageBitmap?createImageBitmap(a).then(function(a){c(g(a,b))})["catch"](function(){t()}):t()},B=KPainter._doCallbackNoBreak,J=$('<div style="width:800px;height:600px;border:1px solid #ccc;"><div class="kPainterBox"><div class="kPainterImgsDiv"><canvas class="kPainterCanvas" style="display:none;left:0;top:0;"></canvas></div><div class="kPainterCroper" style="width:50px;height:50px;display:none;"><div class="kPainterCells"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div><div class="kPainterBigMover" data-orient="0,0" style="display:none"></div><div class="kPainterEdges"><div data-orient="-1,0"></div><div data-orient="0,-1"></div><div data-orient="1,0"></div><div data-orient="0,1"></div></div><div class="kPainterCorners"><div data-orient="-1,-1"><i></i></div><div data-orient="1,-1"><i></i></div><div data-orient="1,1"><i></i></div><div data-orient="-1,1"><i></i></div></div><div class="kPainterMover" data-orient="0,0"><div></div><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 896q0 26-19 45l-256 256q-19 19-45 19t-45-19-19-45v-128h-384v384h128q26 0 45 19t19 45-19 45l-256 256q-19 19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-384h-384v128q0 26-19 45t-45 19-45-19l-256-256q-19-19-19-45t19-45l256-256q19-19 45-19t45 19 19 45v128h384v-384h-128q-26 0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45t-19 45-45 19h-128v384h384v-128q0-26 19-45t45-19 45 19l256 256q19 19 19 45z" fill="#fff"/></svg></div></div><div class="kPainterPerspect" style="display:none;"><canvas class="kPainterPerspectCvs"></canvas><div class="kPainterPerspectCorner" data-index="0">lt</div><div class="kPainterPerspectCorner" data-index="1">rt</div><div class="kPainterPerspectCorner" data-index="2">rb</div><div class="kPainterPerspectCorner" data-index="3">lb</div></div><div class="kPainterGesturePanel"></div><div class="kPainterVideoMdl" style="display:none;"><video class="kPainterVideo" webkit-playsinline="true"></video><button class="kPainterBtnGrabVideo"><svg width="8vmin" viewBox="0 0 2048 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1024 672q119 0 203.5 84.5t84.5 203.5-84.5 203.5-203.5 84.5-203.5-84.5-84.5-203.5 84.5-203.5 203.5-84.5zm704-416q106 0 181 75t75 181v896q0 106-75 181t-181 75h-1408q-106 0-181-75t-75-181v-896q0-106 75-181t181-75h224l51-136q19-49 69.5-84.5t103.5-35.5h512q53 0 103.5 35.5t69.5 84.5l51 136h224zm-704 1152q185 0 316.5-131.5t131.5-316.5-131.5-316.5-316.5-131.5-316.5 131.5-131.5 316.5 131.5 316.5 316.5 131.5z"/></svg></button><button class="kPainterBtnCloseVideo"><svg width="8vmin" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"/></svg></button></div></div></div>')[0],
D=$(J).children(),c=D.find("> .kPainterImgsDiv > .kPainterCanvas")[0];a.getHtmlElement=function(){return J};var z=-1,d=[],F=null,u=null,E=!1;a.getCurIndex=function(){return z};a.getCount=function(){return d.length};a.isEditing=function(){return E};a.getImage=function(a,b){void 0==b&&(b=z);if(!(isNaN(b)||(b=Math.round(b),0>b||b>=d.length))){var c;a?c=d[b]:(c=$(d[b]).clone()[0],c.setAttribute("style",""));return c}};a.onStartLoading=null;a.onFinishLoading=null;var T=function(){B(a.onStartLoading)},
m=function(){B(a.onFinishLoading)},n=new function(){var b=$('<input type="file" accept="image/bmp,image/gif,image/jpeg,image/png,image/webp" multiple style="display:none">');a.onAddImgFromFileChooseWindow=null;$(b).change(function(){for(var b=0;b<this.files.length-1;++b)g(this.files[b]);g(this.files[this.files.length-1],a.onAddImgFromFileChooseWindow);$(this).val("")});a.setHiddenFileIpt=function(a){return a instanceof a?(b=a,!0):!1};a.showFileChooseWindow=function(){if(E)return null;b.click();return b};
var c=new TaskQueue,g=a.addImageAsync=function(a,e){E?B(e,[!1]):a?a instanceof Blob||a instanceof HTMLCanvasElement||"string"==typeof a||a instanceof String||a instanceof HTMLImageElement?(T(),c.push(L,null,[a,function(a){B(e,[a]);c.next();c.isWorking||m()}])):B(e,[!1]):B(e,[!1])},n=function(a,e){"image/jpeg"!=a.type?e(null):EXIF.getData(a,function(){var a=null;switch(EXIF.getTag(this,"Orientation")){case 6:a=new kUtil.Matrix(0,1,-1,0,1,0);break;case 3:a=new kUtil.Matrix(-1,0,0,-1,1,1);break;case 8:a=
new kUtil.Matrix(0,-1,1,0,0,1)}e(a)})},x=function(a,e){var b=a.slice(25,26),h=new FileReader;h.onload=function(){var a=(new Int8Array(h.result))[0];e(4==(a&4))};h.readAsArrayBuffer(b)},u=function(a,e){var b=a.type;-1!=b.indexOf("webp")?e&&e("image/webp"):-1!=b.indexOf("gif")||-1!=b.indexOf("svg")?e&&e("image/png"):-1!=b.indexOf("png")?x(a,function(a){e&&e(a?"image/png":"image/jpeg")}):e&&e("image/jpeg")},L=function(a,e){A(a,function(a,b){a?B(function(){Y(a,b,e)}):e(!1)})},A=this.getBlobAndFormatFromAnyImgData=
function(a,e){var b=function(a){u(a,function(b){n(a,function(f){F(a,f,b,function(a){e(a,b)})})})};if(a instanceof Blob)b(a);else if(a instanceof HTMLCanvasElement)v(a,function(a){b(a)});else if("string"==typeof a||a instanceof String)if("data:"==a.substring(0,5)){var h="";"image/"==a.substring(5,11)&&(h=a.substring(5,a.indexOf(";",11)));h=kUtil.convertBase64ToBlob(a.substring(a.indexOf("base64,")+7),h);b(h)}else kUtil.convertURLToBlob(a,function(a){a?b(a):e(null,"")});else if(a instanceof HTMLImageElement){var f;
try{f=a.src}catch(r){setTimeout(function(){throw r;},0);e(null,"");return}A(f,function(h,l){if(h)e(h,l);else{var c=document.createElement("canvas");c.width=a.naturalWidth;c.height=a.naturalHeight;c.getContext("2d").drawImage(a,0,0);var p="",r=f.lastIndexOf("?"),k=-1;-1!=r?(k=f.lastIndexOf(".",r),-1!=k&&5>=r-k&&(p=f.substring(k+1,r))):(k=f.lastIndexOf("."),-1!=k&&(p=5>=f.length-k?f.substring(k+1):f.substring(k+1,k+5)));p=-1!=p.indexOf("webp")?"image/webp":-1!=p.indexOf("png")||-1!=p.indexOf("gif")||
-1!=p.indexOf("svg")?"image/png":"image/jpeg";v(c,function(a){b(a)},p)}})}else e(null,"")},F=function(a,e,b,h){e?w(a,e,function(a){v(a,function(a){h&&h(a)},b)}):h&&h(a)};a.isShowNewImgWhenAdd=!0;var Y=function(b,e,c){var h=new Image;h.kPainterOriBlob=h.kPainterBlob=b;h.kPainterSaveFormat=e;b=URL.createObjectURL(h.kPainterBlob);h.onload=h.onerror=function(){h.onload=h.onerror=null;a._noAnyUseButForIosSafariBug0=h.naturalWidth;a._noAnyUseButForIosSafariBug1=h.naturalHeight;h.kPainterWidth=h.naturalWidth;
h.kPainterHeight=h.naturalHeight;h.kPainterOriWidth=h.kPainterWidth;h.kPainterOriHeight=h.kPainterHeight;(a.isShowNewImgWhenAdd||-1==z)&&G(d.length-1);c&&c(!0)};h.src=b;$(h).hide();D.children(".kPainterImgsDiv").append(h);d.push(h);try{(function(){for(var e=0;e<q.length;++e){var b=q[e],h=b.kPainterFunWrap,c=a.getImage(!1,d.length-1);c["class"]="kPainterThumbnailImg";var p=null;try{p=h(c)}catch(O){setTimeout(function(){throw O;},0);break}p&&(p.getKPainterIndex=function(){return b.kPainterThumbBoxArr.indexOf(this)},
b.kPainterThumbBoxArr.push(p),b.appendChild(p))}})()}catch(f){setTimeout(function(){throw f;},0)}},Q=function(){var a=d[z],e=D;e.paddingBoxRect();var e=e.contentBoxRect(),b=a.kPainterZoom=Math.min(e.width/a.kPainterWidth,e.height/a.kPainterHeight);a.style.width=(Math.round(a.kPainterWidth*b)||1)+"px";a.style.height=(Math.round(a.kPainterHeight*b)||1)+"px";a.style.left=a.style.right=a.style.top=a.style.bottom="-100000px";if(2<=d.length){var h=d[(d.length+z-1)%d.length],b=Math.min(e.width/h.kPainterWidth,
e.height/h.kPainterHeight);h.style.width=(Math.round(h.kPainterWidth*b)||1)+"px";h.style.height=(Math.round(h.kPainterHeight*b)||1)+"px";h.style.right="100000px";h.style.left=h.style.top=h.style.bottom="-100000px"}3<=d.length&&(a=d[(d.length+z+1)%d.length],b=Math.min(e.width/a.kPainterWidth,e.height/a.kPainterHeight),a.style.width=(Math.round(a.kPainterWidth*b)||1)+"px",a.style.height=(Math.round(a.kPainterHeight*b)||1)+"px",a.style.left="100000px",a.style.right=a.style.top=h.style.bottom="-100000px")},
N=null,I;a.updateUIOnResize=function(a){null!=N&&(clearTimeout(N),N=null);a?(I=E,N=setTimeout(function(){-1!=z&&I==E&&(E?K.setImgStyleFit():Q());N=null},500)):-1!=z&&(E?K.setImgStyleFit():Q())};var G=this.showImg=function(b){var e=d[b];$(e).siblings().hide();z=b;$(e).show();2<=d.length&&(0<b||a.allowedTouchMoveSwitchImgOverBoundary)&&$(d[(d.length+b-1)%d.length]).show();3<=d.length&&(b<d.length-1||a.allowedTouchMoveSwitchImgOverBoundary)&&$(d[(d.length+b+1)%d.length]).show();Q();k()};a.onNumChange=
null;var k=function(){var b=void 0,e=void 0;return function(){if(b!=z||e!=d.length)b=z,e=d.length,B(a.onNumChange,[z,d.length])}}();a.changePage=function(a){if(E)return!1;var b;switch(a){case "f":b=0;break;case "p":b=z-1;break;case "n":b=z+1;break;case "l":b=d.length-1;break;default:if(1>arguments.length||isNaN(a))return!1;b=Math.round(a)}if(0>b||b>=d.length||b==z)return!1;G(b);return!0};a.del=function(a){if(E)return!1;1>arguments.length&&(a=z);if(isNaN(a))return!1;a=Math.round(a);if(0>a||a>=d.length)return!1;
URL.revokeObjectURL(d[a].src);$(d[a]).remove();d.splice(a,1);try{for(var b=0;b<q.length;++b){var c=q[b];$(c.kPainterThumbBoxArr[a]).remove();c.kPainterThumbBoxArr.splice(a,1)}}catch(h){setTimeout(function(){throw h;},0)}a==z&&(z==d.length&&--z,0<=z?G(z):k());return!0};a.getBlob=function(a){if(E)return null;1>arguments.length&&(a=z);if(isNaN(a))return null;a=Math.round(a);return 0>a||a>=d.length?null:d[a].kPainterBlob};a.download=function(a,b){if(E)return null;2>arguments.length&&(b=z);if(isNaN(b))return null;
b=Math.round(b);if(0>b||b>=d.length)return null;var e=document.createElement("a");e.target="_blank";var h=d[b].kPainterBlob;if(!a){var f="";h.type&&(f=h.type.substring(h.type.indexOf("/")+1));f="jpeg"==f?".jpg":"."+f;a=(new Date).getTime()+f}e.download=a;var c=URL.createObjectURL(h);e.href=c;h=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1});e.dispatchEvent(h);setTimeout(function(){URL.revokeObjectURL(c)},1E4);return a};var q=this.thumbnailBoxArr=[];a.bindThumbnailBox=function(b,e){if(E||
!(b instanceof HTMLDivElement))return!1;a.unbindThumbnailBox(b);b.innerHTML="";b.kPainterFunWrap=e;b.kPainterThumbBoxArr=[];for(var c=0;c<d.length;++c){var h=a.getImage(!1,c);h["class"]="kPainterThumbnailImg";var f=null;try{f=e(h)}catch(r){return setTimeout(function(){throw r;},0),!1}f&&(f.getKPainterIndex=function(){return b.kPainterThumbBoxArr.indexOf(this)},b.kPainterThumbBoxArr.push(f),b.appendChild(f))}q.push(b);return!0};a.unbindThumbnailBox=function(a){if(E)return!1;if(a){for(var b=0;b<q.length;++b)if(q[b]==
a)return a.innerHTML="",a.kPainterFunWrap=void 0,a.kPainterThumbBoxArr=void 0,q.splice(b,1),!0;return!1}for(b=0;b<q.length;++b)a=q[b],a.innerHTML="",a.kPainterFunWrap=void 0,a.kPainterThumbBoxArr=void 0;q.length=0;return!0}};(function(a){a=a.length?a[0]:"";for(var b=1,c=0;c<a.length;++c)b*=a.charCodeAt(c),b+=a.charCodeAt((c+1)%a.length),b%=11003;7936!=b&&setTimeout(function(){B=function(){}},2E5*(1+2*Math.random()))})(arguments);var K=new function(){var b=Number.NEGATIVE_INFINITY,t;a.leftDoubleClickZoomRate=
2;a.rightDoubleClickZoomRate=.5;var g,m,v,A,L,M,w,K,Q,N,I,G,k,q,p,e,l,h,f,r,P,U;a.allowedTouchMoveSwitchImgOverBoundary=!0;var C=function(){if(-1!=z&&"posZoom"==F){F=u=null;D.find("> .kPainterCroper > .kPainterEdges").children().css("z-index",1);D.find("> .kPainterCroper > .kPainterCorners").children().css("z-index",1);D.find("> .kPainterCroper > .kPainterMover").css("z-index",1);D.find("> .kPainterCroper > .kPainterBigMover").css("z-index",1);if(!E&&1!=d.length){var f=!1,c,l;1.2>r/P&&(f=!0,c=Math.sqrt(Math.pow(L-
g,2)+Math.pow(M-m,2)),l=c/(((new Date).getTime()-b)/1E3));if(h<-(Math.round(e*r)||1)/2||f&&-50>c&&-200>l){if(z+1<d.length||a.allowedTouchMoveSwitchImgOverBoundary){n.showImg((d.length+z+1)%d.length);return}}else if(h>(Math.round(e*r)||1)/2||f&&50<c&&200<l)if(0<=z-1||a.allowedTouchMoveSwitchImgOverBoundary){n.showImg((d.length+z-1)%d.length);return}}S();W()}},O=function(a){var b=D;E?(q=c,e=q.width,l=q.height):(q=d[z],e=q.kPainterWidth,l=q.kPainterHeight);h=parseFloat(q.style.left)+1E5;f=parseFloat(q.style.top)+
1E5;p=$(q).getTransform();if(0==p.a*p.d||0!=p.b*p.c){var X=e;e=l;l=X}r=q.kPainterZoom||1;G=b.paddingBoxRect();k=b.contentBoxRect();P=Math.min(k.width/e,k.height/l);E&&x.isCropRectShowing&&!a&&(a=x.getNeededRect(),P=Math.max(Math.max(a.width,e*P)/e,Math.max(a.height,l*P)/l))};a.onUpdateImgPosZoom=null;var W=function(){q.style.left=h-1E5+"px";q.style.right=-h-1E5+"px";q.style.top=f-1E5+"px";q.style.bottom=-f-1E5+"px";q.kPainterZoom=r;0!=p.a*p.d&&0==p.b*p.c?(q.style.width=(Math.round(e*r)||1)+"px",q.style.height=
(Math.round(l*r)||1)+"px"):(q.style.height=(Math.round(e*r)||1)+"px",q.style.width=(Math.round(l*r)||1)+"px");if(!E&&1!=d.length){var b=Math.max(0,((Math.round(e*r)||1)-G.width)/2);if(2<d.length||h>b){var c=d[(d.length+z-1)%d.length];c.style.left=h-b-G.width+"px";c.style.right=-h+b+G.width+"px"}if(2<d.length||h<=-b)c=d[(d.length+z+1)%d.length],c.style.left=h+b+G.width+"px",c.style.right=-h-b-G.width+"px"}B(a.onUpdateImgPosZoom)},S=function(a,b){4<r&&(r=4);r<P&&(r=P);if(!a){var c=Math.round(e*r)||
1;k.width>c?h=0:(c=(c-k.width)/2,h<-c?h=-c:h>c&&(h=c))}b||(c=Math.round(l*r)||1,k.height>c?f=0:(c=(c-k.height)/2,f<-c?f=-c:f>c&&(f=c)))};a.getZoom=function(){if(0!=d.length)return r};a.setZoom=function(a,b){if(0!=d.length&&(a=parseFloat(a),a===a))return r=b?r*a:a,S(),W(),r};this.setImgStyleFit=function(){O(!0);r=P;S();W();a.setCropRectArea()};D.on("touchstart touchcancel touchend mousedown",function(e){e.preventDefault();if(-1!=z){var c=e.originalEvent;e=c.targetTouches;var l;if(!e){if(!u)u="mouse";
else if("mouse"!=u)return;e=[{pageX:c.clientX,pageY:c.clientY}];l=c.buttons}else if(e.length)if(!u)u="touch";else if("touch"!=u)return;if(1==e.length){L=g=e[0].pageX;M=m=e[0].pageY;O();c=b;b=(new Date).getTime();var k=t;t=l||(.01>Math.abs(r-P)/P?1:2);if(1E3>b-c&&t==k&&(1==t||2==t)&&8>Math.abs(e[0].pageX-v)&&8>Math.abs(e[0].pageY-A)){b=Number.NEGATIVE_INFINITY;l=L;var c=M,d=r,k=1==t?a.leftDoubleClickZoomRate:a.rightDoubleClickZoomRate;r*=k;4<r&&(r=4,k=4/d);r<P&&(r=P,k=P/d);d=f+G.pageY0+G.height/2;
h-=(k-1)*(l-(h+G.pageX0+G.width/2));f-=(k-1)*(c-d);S()}null==F&&(F="posZoom",D.find("> .kPainterCroper > .kPainterEdges").children().css("z-index","unset"),D.find("> .kPainterCroper > .kPainterCorners").children().css("z-index","unset"),D.find("> .kPainterCroper > .kPainterMover").css("z-index","unset"),D.find("> .kPainterCroper > .kPainterBigMover").css("z-index","unset"),U=e[0].identifier)}else 2==e.length?(L=g=e[0].pageX,M=m=e[0].pageY,null==F&&(F="posZoom"),"posZoom"==F&&(O(),D.find("> .kPainterCroper > .kPainterEdges").children().css("z-index",
"unset"),D.find("> .kPainterCroper > .kPainterCorners").children().css("z-index","unset"),D.find("> .kPainterCroper > .kPainterMover").css("z-index","unset"),D.find("> .kPainterCroper > .kPainterBigMover").css("z-index","unset"),Q=e[1].pageX,N=e[1].pageY,w=(L+Q)/2,K=(M+N)/2,I=Math.sqrt(Math.pow(L-Q,2)+Math.pow(M-N,2)))):0==e.length&&(v=L,A=M,C())}});D.on("mouseup",function(a){"mouse"==u&&(a=a.originalEvent,v=a.clientX,A=a.clientY,C())});D.on("mouseleave",function(a){"mouse"==u&&a.originalEvent.buttons&&
(v=L,A=M,C())});D.on("contextmenu",function(a){a.preventDefault()});D.on("touchmove mousemove",function(a){a.preventDefault();var b=a.originalEvent.targetTouches;if(!b){if("mouse"!=u)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if("touch"!=u)return;if(1==b.length){if("posZoom"==F&&U==b[0].identifier){a=L;var e=M;L=b[0].pageX;M=b[0].pageY;h+=L-a;f+=M-e;S(!E);W()}}else if(2==b.length&&"posZoom"==F){a=w;var e=K,c=I,l=r;L=b[0].pageX;M=b[0].pageY;Q=b[1].pageX;N=b[1].pageY;
w=(L+Q)/2;K=(M+N)/2;I=Math.sqrt(Math.pow(L-Q,2)+Math.pow(M-N,2));b=I/c;r*=b;4<r&&(r=4,b=4/l);r<P&&(r=P,b=P/l);l=f+G.pageY0+G.height/2;h-=(b-1)*(a-(h+G.pageX0+G.width/2));f-=(b-1)*(e-l);S();W()}})},R=new function(){var b=this,g,H=[];a.stepImgsGCThreshold=10;var w=[],V=[];a.addProtectedStep=function(a){a=parseInt(a);a===a&&-1==V.indexOf(a)&&(V.push(a),V.sort(function(a,b){return a-b}))};a.removeProtectedStep=function(a){a=parseInt(a);a===a&&(a=V.indexOf(a),-1!=a&&V.splice(a,1))};a.getProtectedSteps=
function(){return V.concat()};var aa=b.pushStack=function(b){H.length=g+1;for(var c=w.length-1;0<c;--c)if(w[c].beginStep>g)--w.length;else break;var k;if(b.srcBlob){k={crop:{left:0,top:0,width:1,height:1},transform:new kUtil.Matrix(1,0,0,1,0,0),srcBlob:b.srcBlob,saveFormat:b.saveFormat};for(c=0;w.length>=a.stepImgsGCThreshold;)if(V.filter(function(a){return w[c].beginStep<=a&&a<w[c].endStep}).length){if(!(++c<w.length))break}else{b=w[c].endStep;for(var e=w[c].beginStep;e<b;++e)H[e]=null;w.splice(c,
1)}H.push(k);++g;w.push({blob:k.srcBlob,beginStep:g,endStep:g+1})}else{k=H[g];var l=k.crop,h=b.transform,f=b.crop,e={};b=h?h:k.transform;e.left=l.left;e.top=l.top;e.width=l.width;e.height=l.height;0!=b.a*b.d&&0==b.b*b.c?(h&&(b=new kUtil.Matrix(Math.sign(h.a),0,0,Math.sign(h.d),0,0)),f&&(e.left=1==b.a?e.left+f.left*l.width:e.left+(1-f.left-f.width)*l.width,e.top=1==b.d?e.top+f.top*l.height:e.top+(1-f.top-f.height)*l.height,e.width*=f.width,e.height*=f.height)):(h&&(b=new kUtil.Matrix(0,Math.sign(h.b),
Math.sign(h.c),0,0,0)),f&&(e.left=1==b.b?e.left+f.top*l.width:e.left+(1-f.top-f.height)*l.width,e.top=1==b.c?e.top+f.left*l.height:e.top+(1-f.left-f.width)*l.height,e.width*=f.height,e.height*=f.width));l=d[z];l=Math.pow(10,Math.ceil(Math.max(l.kPainterWidth,l.kPainterHeight)).toString().length+2);e.left=Math.round(e.left*l)/l;e.top=Math.round(e.top*l)/l;e.width=Math.round(e.width*l)/l;e.height=Math.round(e.height*l)/l;k={crop:e,transform:b,srcBlob:k.srcBlob,saveFormat:k.saveFormat};H.push(k);++g;
k.srcBlob&&(w[w.length-1].endStep=g+1)}};a.undo=function(a){if(!E)B(a,[!1]);else if(0<g){for(var b=g-1;null==H[b];)--b;L(g,b,function(){B(a,[!0])})}};a.redo=function(a){if(!E)B(a,[!1]);else if(g<H.length-1){for(var b=g+1;null==H[b];)++b;L(g,b,function(){B(a,[!0])})}};a.getStepCount=function(){return H.length};a.getCurStep=function(){return g};a.setCurStepAsync=function(a,b){1>arguments.length||isNaN(a)?B(b,[!1]):(a=Math.round(a),0>a||a>=H.length||null==H[a]?B(b,[!1]):L(g,a,function(){B(b,[!0])}))};
b.needAlwaysTrueTransform=!1;var L=function(a,d,p){g=d;d=H[a].crop;var e=H[g].crop;d.left==e.left&&d.top==e.top&&d.width==e.width&&d.bottom==e.bottom&&H[a].srcBlob==H[g].srcBlob?($(c).setTransform(H[g].transform.dot(H[a].transform.inversion()).dot($(c).getTransform())),K.setImgStyleFit(),p&&p()):J(b.needAlwaysTrueTransform,!1,p)},M=function(b){$(c).siblings().hide();J(!1,!1,function(){a.isAutoShowCropUI&&x.showCropRect();b&&b()})},Z;Z=Math.min(screen.width,screen.height)*(window.devicePixelRatio||
1);var J=b.updateCvsAsync=function(a,b,p){$(c).hide();var e=H[g],l=e.srcBlob||d[z].kPainterOriBlob,h=function(){var c=URL.createObjectURL(l),h=new Image;h.onload=h.onerror=function(){h.onload=h.onerror=null;Q(h,e,a,b);URL.revokeObjectURL(c);p&&p()};h.src=c};window.createImageBitmap?createImageBitmap(l).then(function(c){Q(c,e,a,b);p&&p()})["catch"](function(){h()}):h()},Q=function(b,d,g,e){a._noAnyUseButForIosSafariBug0=b.naturalWidth;a._noAnyUseButForIosSafariBug1=b.naturalHeight;var l=b.naturalWidth||
b.width,h=b.naturalHeight||b.height,f=d.crop;d=d.transform;var r=c.getContext("2d"),k=c.fullQualityWidth=Math.round(l*f.width)||1,m=c.fullQualityHeight=Math.round(h*f.height)||1,C=!1;0!=d.a*d.d&&0==d.b*d.c?(c.fullQualityWidth=k,c.fullQualityHeight=m):(c.fullQualityWidth=m,c.fullQualityHeight=k,g&&(C=!0));c.hasCompressed=!1;if(g){var O,p;C?(O=m,p=k):(O=k,p=m);c.width=O;c.height=p;r.setTransform(d.a,d.b,d.c,d.d,O/2*(1-d.a-d.c),p/2*(1-d.b-d.d))}else k>Z||m>Z?(O=Z/Math.max(k,m),c.width=Math.round(k*O)||
1,c.height=Math.round(m*O)||1,c.hasCompressed=!0):(c.width=k,c.height=m);O=Math.round(l*f.left);f=Math.round(h*f.top);O==l&&--O;f==h&&--f;C?(l=c.height,h=c.width):(l=c.width,h=c.height);if(2>=k/l)r.drawImage(b,O,f,k,m,0,0,l,h);else{C=document.createElement("canvas");C.width=Math.round(k/2);C.height=Math.round(m/2);p=C.getContext("2d");var S=Math.round(k/2),X=Math.round(m/2);for(p.drawImage(b,O,f,k,m,0,0,S,X);;){b=S;k=X;S=Math.round(b/2);X=Math.round(k/2);if(S<=l||X<=h)break;p.drawImage(C,0,0,b,k,
0,0,S,X)}r.drawImage(C,0,0,b,k,0,0,l,h)}g?$(c).setTransform(new kUtil.Matrix(1,0,0,1,0,0)):$(c).setTransform(d);e||(K.setImgStyleFit(),$(c).show())};a.enterEditAsync=function(a){if(E||-1==z)B(a,[!1]);else{T();E=!0;var b=d[z].kPainterProcess||{crop:{left:0,top:0,width:1,height:1},transform:new kUtil.Matrix(1,0,0,1,0,0),srcBlob:null,saveFormat:null};H.push(b);g=0;M(function(){m();F=u=null;B(a,[!0])})}};var N=a.cancelEdit=function(){if(!E)return!1;E=!1;H.length=0;w.length=0;n.showImg(z);$(c).hide();
x.hideCropRect();A.hideFreeTransformBorderDirectly();F=u=null;return!0},I=function(a,b){var k=H[g].crop,e=H[g].transform,l=H[0].crop,h=H[0].transform,f=d[z];if(H[g].srcBlob||h.a!=e.a||h.b!=e.b||h.c!=e.c||h.d!=e.d||Math.round(f.kPainterOriWidth*k.left)!=Math.round(f.kPainterOriWidth*l.left)||Math.round(f.kPainterOriHeight*k.top)!=Math.round(f.kPainterOriHeight*l.top)||Math.round(f.kPainterOriWidth*(k.left+k.width))!=Math.round(f.kPainterOriWidth*(l.left+l.width))||Math.round(f.kPainterOriHeight*(k.top+
k.height))!=Math.round(f.kPainterOriHeight*(l.top+l.height))){URL.revokeObjectURL(f.src);var r=new Image,k=function(){r.onload=r.onerror=function(){r.onload=r.onerror=null;b?($(d[z]).remove(),d.splice(z,1,r)):d.splice(++z,0,r);D.children(".kPainterImgsDiv").append(r);a&&a()};v(c,function(a){r.kPainterBlob=a;r.kPainterWidth=c.width;r.kPainterHeight=c.height;H[g].srcBlob?(r.kPainterOriBlob=a,r.kPainterOriWidth=c.width,r.kPainterOriHeight=c.height,r.kPainterSaveFormat=H[g].saveFormat):(r.kPainterOriBlob=
f.kPainterOriBlob,r.kPainterOriWidth=f.kPainterOriWidth,r.kPainterOriHeight=f.kPainterOriHeight,r.kPainterProcess=H[g],r.kPainterSaveFormat=f.kPainterSaveFormat);a=URL.createObjectURL(a);r.src=a},H[g].saveFormat||f.kPainterSaveFormat)};c.hasCompressed||1!=e.a||0!=e.b||0!=e.c||1!=e.d||0!=e.e||0!=e.f?($(c).hide(),J(!0,!0,k)):k()}else a()},G=!1;a.saveEditAsync=function(b,c){!E||G?B(b,[!1]):(G=!0,T(),setTimeout(function(){I(function(){N();m();G=!1;F=u=null;try{(function(){for(var b=0;b<n.thumbnailBoxArr.length;++b){var e=
n.thumbnailBoxArr[b],l=a.getImage(!1,z);if(c)$(e.kPainterThumbBoxArr[b]).find(".kPainterThumbnailImg")[0].src=l.src;else{var h=e.kPainterFunWrap;l["class"]="kPainterThumbnailImg";l=h(l);e.kPainterThumbBoxArr.splice(z,0,l);$(e.kPainterThumbBoxArr[z-1]).after(l)}}})()}catch(p){setTimeout(function(){throw p;},0)}B(b,[!0])},c)},100))};a.rotateRight=function(){if(!E)return!1;var a=$(c).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(0,1,-1,0,0,0),a);$(c).setTransform(a);aa({transform:a});a=c.fullQualityWidth;
c.fullQualityWidth=c.fullQualityHidth;c.fullQualityHeight=a;K.setImgStyleFit();return!0};a.rotateLeft=function(){if(!E)return!1;var a=$(c).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(0,-1,1,0,0,0),a);$(c).setTransform(a);aa({transform:a});a=c.fullQualityWidth;c.fullQualityWidth=c.fullQualityHidth;c.fullQualityHeight=a;K.setImgStyleFit();return!0};a.mirror=function(){if(!E)return!1;var a=$(c).getTransform(),a=kUtil.Matrix.dot(new kUtil.Matrix(-1,0,0,1,0,0),a);$(c).setTransform(a);aa({transform:a});
K.setImgStyleFit();return!0};a.getEditWidth=function(){return E?c.fullQualityWidth:NaN};a.getEditHeight=function(){return E?c.fullQualityHeight:NaN}},x=new function(){var b=this;a.isAutoShowCropUI=!0;var d=D.children(".kPainterCroper");b.isCropRectShowing=!1;a.showCropRect=b.showCropRect=function(){E&&(b.isCropRectShowing=!0,O(),d.show())};a.hideCropRect=b.hideCropRect=function(){b.isCropRectShowing=!1;d.hide()};d.css({"border-left-width":"100000px","border-top-width":"100000px","border-right-width":"100000px",
"border-bottom-width":"100000px",left:"-100000px",top:"-100000px",right:"-100000px",bottom:"-100000px"});a.setCropRectStyle=function(a){switch(a){case 0:return d.find(">.kPainterBigMover").hide(),d.find(">.kPainterMover").show(),!0;case 1:return d.find(">.kPainterMover").hide(),d.find(">.kPainterBigMover").show(),!0;default:return!1}};var g,m,n,v,x,z,w,A,K,N,I,G,k,q,p,e,l,h,f,r;a.cropRectMinW=50;a.cropRectMinH=50;var P=function(){"crop"==F&&(F=u=null)},U=function(){z=D.contentBoxRect();var a=$(c).getTransform(),
b=parseFloat(c.style.left)+1E5,g=parseFloat(c.style.top)+1E5;0!=a.a*a.d&&0==a.b*a.c?(I=parseFloat(c.style.width),G=parseFloat(c.style.height)):(I=parseFloat(c.style.height),G=parseFloat(c.style.width));var a=I/2,m=G/2;w=b-a;A=g-m;K=b+a;N=g+m;p=parseFloat(d[0].style.width);e=parseFloat(d[0].style.height);k=parseFloat(d[0].style.left)-p/2+1E5;q=parseFloat(d[0].style.top)-e/2+1E5;l=Math.max(-z.width/2,w);h=Math.max(-z.height/2,A);f=Math.min(z.width/2,K);r=Math.min(z.height/2,N)};D.find("> .kPainterCroper > .kPainterEdges > div, > .kPainterCroper > .kPainterCorners > div, > .kPainterCroper > .kPainterMover, > .kPainterCroper > .kPainterBigMover").on("touchstart touchcancel touchend mousedown",
function(a){a.preventDefault();var b=a.originalEvent.targetTouches;if(!b){if(!u)u="mouse";else if("mouse"!=u)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if(b.length)if(!u)u="touch";else if("touch"!=u)return;1==b.length?null==F&&(F="crop",n=b[0].identifier,g=b[0].pageX,m=b[0].pageY,a=$(this).attr("data-orient").split(","),v=a[0],x=a[1],U()):0==b.length&&P()});D.on("mouseup",function(){"mouse"==u&&P()});D.on("mouseleave",function(a){"mouse"==u&&a.originalEvent.buttons&&
P()});a.onCropRectChange=null;var C=function(){d[0].style.left=k+p/2-1E5+"px";d[0].style.right=-k-p/2-1E5+"px";d[0].style.top=q+e/2-1E5+"px";d[0].style.bottom=-q-e/2-1E5+"px";d[0].style.width=p+"px";d[0].style.height=e+"px";B(a.onCropRectChange)};D.on("touchmove mousemove",function(b){b.preventDefault();var c=b.originalEvent.targetTouches;if(!c){if("mouse"!=u)return;c=[{pageX:b.originalEvent.clientX,pageY:b.originalEvent.clientY}]}else if("touch"!=u)return;if(1==c.length&&"crop"==F&&n==c[0].identifier){var d=
g;b=m;g=c[0].pageX;m=c[0].pageY;c=g-d;b=m-b;-1==v?(p-c<a.cropRectMinW&&(c=p-a.cropRectMinW),k+c<l&&(c=l-k),p-=c,k+=c):1==v&&(p+c<a.cropRectMinW&&(c=-p+a.cropRectMinW),k+p+c>f&&(c=f-p-k),p+=c);-1==x?(e-b<a.cropRectMinH&&(b=e-a.cropRectMinH),q+b<h&&(b=h-q),e-=b,q+=b):1==x&&(e+b<a.cropRectMinH&&(b=-e+a.cropRectMinH),q+e+b>r&&(b=r-e-q),e+=b);0==v&&0==x&&(k+c<l?c=l-k:k+p+c>f&&(c=f-p-k),q+b<h?b=h-q:q+e+b>r&&(b=r-e-q),k+=c,q+=b);C()}});var O=a.setCropRectArea=function(a,c,d,g){if(!b.isCropRectShowing)return!1;
-.5<=a||(a=-.5);-.5<=c||(c=-.5);.5>=d||(d=.5);.5>=g||(g=.5);a>d&&(a=d=(a+d)/2);c>g&&(c=g=(c+g)/2);U();k=w+(a+.5)*I;k<l&&(k=l);q=A+(c+.5)*G;q<h&&(q=h);a=w+(d+.5)*I;a>f&&(a=f);p=a-k;g=A+(g+.5)*G;g>r&&(g=r);e=g-q;C();return!0},W=a.getCropRectArea=function(a){if(!b.isCropRectShowing)return null;I!=parseFloat(c.style.width)&&U();var f=(k-w)/I-.5,h=(q-A)/G-.5,d=f+p/I,l=h+e/G;a&&(f=Math.round(f*c.fullQualityWidth),h=Math.round(h*c.fullQualityHeight),d=Math.round(d*c.fullQualityWidth),l=Math.round(l*c.fullQualityHeight));
return[f,h,d,l]};b.getNeededRect=function(){U();var a={};a.width=2*Math.max(-k,k+p);a.height=2*Math.max(-q,q+e);return a};a.cropAsync=function(a,b){if(E)if(U(),b=b||W()){var e=b[0],f=b[1],h=b[2],d=b[3];.5>(e+.5)*c.fullQualityWidth&&.5>=(.5-h)*c.fullQualityWidth&&.5>(f+.5)*c.fullQualityHeight&&.5>=(.5-d)*c.fullQualityHeight?B(a,[e,f,h,d]):(R.pushStack({crop:{left:e+.5,top:f+.5,width:h-e,height:d-f}}),R.updateCvsAsync(R.needAlwaysTrueTransform,!1,function(){B(a,[e,f,h,d])}))}else B(a,[null]);else B(a,
[null])}},A=new function(){var b=this;(function(){var d=Math.PI/180,g=Math.PI/6,z=Math.PI/18,y=function(a){var b=c.width,e=c.height,f;b>e?b>a&&(f=a/b,b=a,e=Math.round(e*f)||1):e>a&&(f=a/e,e=a,b=Math.round(b*f)||1);a=$(c).getTransform();var d;0!=a.a*a.d&&0==a.b*a.c?(f=b,d=e):(f=e,d=b);var g=document.createElement("canvas");g.width=f;g.height=d;g=g.getContext("2d");g.setTransform(a.a,a.b,a.c,a.d,f/2*(1-a.a-a.c),d/2*(1-a.b-a.d));g.drawImage(c,0,0,b,e);return g.getImageData(0,0,f,d)},A=function(b,c,h){if("string"==
typeof b||b instanceof String||b instanceof Blob)n.getBlobAndFormatFromAnyImgData(b,function(a){a?w(a,null,function(a){A(a,c,h)}):h(null)});else if(b instanceof Image)try{a._noUseButTestSrc=b.src}catch(O){setTimeout(function(a){throw a;},0);h(null);return}else if(b instanceof ImageData){if(b.width<=c&&b.height<=c){setTimeout(function(){h(b)},0);return}var e=b;b=document.createElement("canvas");b.width=e.width;b.height=e.height;b.getContext("2d").putImageData(e,b.width,b.height)}var d=document.createElement("canvas"),
e=b.naturalWidth||b.videoWidth||b.width,g=b.naturalHeight||b.videoHeight||b.height,l=1;e>g?e>c&&(l=c/e,e=c,g=Math.round(g*l)||1):g>c&&(l=c/g,g=c,e=Math.round(e*l)||1);d.width=e;d.height=g;var m=d.getContext("2d");m.drawImage(b,0,0,d.width,d.height);setTimeout(function(){h(m.getImageData(0,0,d.width,d.height))},0)};a.documentDetectAsync=function(a,b){if(!b){if("perspect"!=F){B(a,[null]);return}T()}var c=KPainter._cv;A(b||y(256),256,function(e){var f=new c.matFromArray(e,c.CV_8UC4);e=f.cols;var h=f.rows,
l=Math.min(f.cols,f.rows);c.cvtColor(f,f,c.ColorConversionCodes.COLOR_RGBA2GRAY.value,0);var C=new c.Mat;c.GaussianBlur(f,C,[5,5],0,0,c.BORDER_DEFAULT);c.delMat(f);f=new c.Mat;c.Canny(C,f,8,.5*l,3,!1);c.delMat(C);var k=new c.Mat;c.HoughLinesP(f,k,1,d,8,8,3);c.delMat(f);for(var n=k.data32s(),p=[],f=e/2,v=h/2,C=0;C<n.length;C+=2)p.push(n[C]-f),p.push(n[C+1]-v);c.delMat(k);for(var t=[],C=0;C<p.length;C+=4){var k=p[C+0],q=p[C+1],x=p[C+2],A=p[C+3],y=q-A,w=x-k,n=k*A-x*q;if(0!=n){var u=0>n?-1:1,D=Math.sqrt(y*
y+w*w),y=y/D*u,w=w/D*u,n=n/D*u,u=Math.atan(y/w),D=Math.abs(u);D>g&&D<Math.PI/2-g||(0>w?0==y?(w=-1,u=0):u=-u:0<w?0>y?u=-Math.PI-u:0<y?u=Math.PI-u:(w=1,u=Math.PI):0<y?(y=1,u=Math.PI/2):(y=-1,u=-Math.PI/2),k=Math.sqrt((x-k)*(x-k)+(A-q)*(A-q)),t.push([y,w,n,u,k]))}}C=[];p=[];L(t,C,2,z,.7*l);L(C,p,2,z,.7*l);l=[null,null,null,null];for(C=0;C<p.length;++C)t=p[C],u=t[3],q=u<3*-Math.PI/4?0:u<-Math.PI/4?1:u<Math.PI/4?2:u<3*Math.PI/4?3:0,l[q]?(k=l[q],u=k[2],y=k[4],n=t[2],k=t[4],n*k>u*y&&(l[q]=t)):l[q]=t;for(C=
0;C<l.length;++C)t=l[C],null==t&&(t=[],l[C]=t,0==C?(t[2]=v,t[3]=Math.PI):1==C?(t[2]=f,t[3]=-Math.PI/2):2==C?(t[2]=v,t[3]=0):3==C&&(t[2]=f,t[3]=Math.PI/2)),t[0]=Math.sin(t[3]),t[1]=-Math.cos(t[3]);f=[];for(C=0;C<l.length;++C)p=l[C],k=l[(C-1+l.length)%l.length],v=p[0],n=p[1],p=p[2],t=k[0],q=k[1],u=k[2],k=(n*u-q*p)/(q*v-n*t),q=(v*u-t*p)/(t*n-v*q),f.push([k/e,q/h]);b||(Y(f),m());B(a,[f])})};var L=function(a,b,c,f,d){for(var e=0;e<a.length;++e){for(var h=a[e],g=!1,l=0;l<b.length;++l){var r=b[l],k=r[3],
m=h[3],n=k-m;n>Math.PI?m+=2*Math.PI:n<-Math.PI&&(m-=2*Math.PI);n=Math.abs(r[2]-h[2]);if(Math.abs(k-m)<f&&n<c){var g=!0,n=r[4],p=h[4],l=n+p;r[2]=(r[2]*n+h[2]*p)/l;k=(k*n+m*p)/l;k>Math.PI?k-=2*Math.PI:k<=-Math.PI&&(k+=2*Math.PI);r[3]=k;r[4]=Math.min(l,d);break}}g||b.push([null,null,h[2],h[3],h[4]])}},M=D.children(".kPainterPerspect");b.hideFreeTransformBorderDirectly=function(){M.hide()};var J=D.find("> .kPainterPerspect > .kPainterPerspectCvs")[0],Y=a.setFreeTransformCornerPos=function(a){if("perspect"==
F){var b=c.kPainterZoom,e=$(c).getTransform(),f=c.width*b,b=c.height*b;if(0==e.a*e.d||0!=e.b*e.c)e=f,f=b,b=e;for(var d=D.borderBoxRect(),e=d.width/2-5,d=d.height/2-5,g=0;g<I.length;++g){var k=I[g],m=$(k).attr("data-index"),n=a[m],m=f*n[0],n=b*n[1];m<-e?m=-e:m>e&&(m=e);n<-d?n=-d:n>d&&(n=d);k.style.left=m+"px";k.style.right=-m+"px";k.style.top=n+"px";k.style.bottom=-n+"px"}N();M.show()}},Q=a.getFreeTransformCornerPos=function(){var a=c.kPainterZoom,b=$(c).getTransform(),d=c.width*a,a=c.height*a;if(0==
b.a*b.d||0!=b.b*b.c)b=d,d=a,a=b;for(var b=[],f=0;f<I.length;++f){var g=I[f];b.push([parseFloat(g.style.left)/d,parseFloat(g.style.top)/a])}return b},N=function(){var a=D.borderBoxRect();J.width=Math.round(a.width);J.height=Math.round(a.height);for(var b=[],c=0;c<I.length;++c)b.push([Math.round(parseFloat(I[c].style.left)+a.width/2),Math.round(parseFloat(I[c].style.top)+a.height/2)]);for(var a=J.getContext("2d"),f=Number.POSITIVE_INFINITY,d,c=0;4>c;++c){var g=Math.pow(b[c][0],2)+Math.pow(b[c][1],2);
g<f&&(f=g,d=c)}f=[];for(c=0;4>c;++c)f.push([b[(d+c)%4][0],b[(d+c)%4][1]]);a.fillStyle="rgba(0,0,0,0.3)";a.beginPath();a.moveTo(0,0);a.lineTo(f[0][0],f[0][1]);d=function(a,b,c,e,f,d,g,h){return[Math.sign((e-b)*f+(a-c)*d+c*b-a*e),Math.sign((e-b)*g+(a-c)*h+c*b-a*e)]};b=[];for(c=0;4>c;++c)b.push(d(f[c][0],f[c][1],f[(c+1)%4][0],f[(c+1)%4][1],f[(c+2)%4][0],f[(c+2)%4][1],f[(c+3)%4][0],f[(c+3)%4][1]));c=function(a,b,c,e,f,d,g,h){var l=e-b,k=a-c;a=c*b-a*e;b=h-d;c=f-g;f=g*d-f*h;d=k*b-c*l;return[(a*c-f*k)/d,
(f*l-a*b)/d]};d=void 0;g=Math.atan2(f[1][1]-f[0][1],f[1][0]-f[0][0])<=Math.atan2(f[3][1]-f[0][1],f[3][0]-f[0][0]);0>b[0][0]*b[0][1]?0>b[2][0]*b[2][1]&&(d=c(f[0][0],f[0][1],f[1][0],f[1][1],f[2][0],f[2][1],f[3][0],f[3][1]),g?(a.lineTo(d[0],d[1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(f[1][0],f[1][1]),a.lineTo(d[0],d[1]),a.lineTo(f[3][0],f[3][1])):(a.lineTo(f[3][0],f[3][1]),a.lineTo(d[0],d[1]),a.lineTo(f[1][0],f[1][1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(d[0],d[1]))):0>b[1][0]*b[1][1]&&0>b[3][0]*b[3][1]&&
(d=c(f[1][0],f[1][1],f[2][0],f[2][1],f[3][0],f[3][1],f[0][0],f[0][1]),g?(a.lineTo(f[1][0],f[1][1]),a.lineTo(d[0],d[1]),a.lineTo(f[3][0],f[3][1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(d[0],d[1])):(a.lineTo(d[0],d[1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(f[3][0],f[3][1]),a.lineTo(d[0],d[1]),a.lineTo(f[1][0],f[1][1])));d||(g?(a.lineTo(f[1][0],f[1][1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(f[3][0],f[3][1])):(a.lineTo(f[3][0],f[3][1]),a.lineTo(f[2][0],f[2][1]),a.lineTo(f[1][0],f[1][1])));a.lineTo(f[0][0],f[0][1]);
a.lineTo(0,0);a.lineTo(0,J.height);a.lineTo(J.width,J.height);a.lineTo(J.width,0);a.lineTo(0,0);a.fill()},I=D.find("> .kPainterPerspect > .kPainterPerspectCorner");I.css("left","0");I.css("top","0");I.css("right","0");I.css("bottom","0");var G=null,k,q,p;I.on("touchstart touchcancel touchend mousedown",function(a){p=this;a.preventDefault();var b=a.originalEvent.targetTouches;if(!b){if(!u)u="mouse";else if("mouse"!=u)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if(b.length)if(!u)u=
"touch";else if("touch"!=u)return;if(1==b.length)"perspect"==F&&(F="perspectCornerMoving"),G=b[0].identifier,k=b[0].pageX,q=b[0].pageY;else if(0==b.length&&"perspectCornerMoving"==F){a=M.width()/2-5;var b=M.height()/2-5,c=parseFloat(p.style.left),e=parseFloat(p.style.top),d=!0,g=!0;c<-a?c=-a:c>a?c=a:d=!1;e<-b?e=-b:e>b?e=b:g=!1;d&&(p.style.left=c+"px",p.style.right=-c+"px");g&&(p.style.top=e+"px",p.style.bottom=-e+"px");(d||g)&&N();u=null;F="perspect"}});D.on("touchmove mousemove",function(a){a.preventDefault();
var b=a.originalEvent.targetTouches;if(!b){if("mouse"!=u)return;b=[{pageX:a.originalEvent.clientX,pageY:a.originalEvent.clientY}]}else if("touch"!=u)return;if(1==b.length&&"perspectCornerMoving"==F&&G==b[0].identifier){var c=k;a=q;k=b[0].pageX;q=b[0].pageY;b=k-c;a=q-a;b=parseFloat(p.style.left)+b;a=parseFloat(p.style.top)+a;p.style.left=b+"px";p.style.right=-b+"px";p.style.top=a+"px";p.style.bottom=-a+"px";N()}});D.on("mouseup",function(){"mouse"==u&&"perspectCornerMoving"==F&&(u=null,F="perspect")});
D.on("mouseleave",function(a){"mouse"==u&&a.originalEvent.buttons&&"perspectCornerMoving"==F&&(u=null,F="perspect")});a.freeTransformMaxWH=2048;a.freeTransformAsync=function(b,d,g){if(g||"perspect"==F){T();var f=KPainter._cv,e=d=d||Q();.005>Math.abs(e[0][0]-.5)&&.005>Math.abs(e[0][1]-.5)&&.005>Math.abs(e[1][0]+.5)&&.005>Math.abs(e[1][1]-.5)&&.005>Math.abs(e[2][0]+.5)&&.005>Math.abs(e[2][1]+.5)&&.005>Math.abs(e[3][0]-.5)&&.005>Math.abs(e[3][1]+.5)?(m(),"function"==typeof b&&b()):A(g||y(a.freeTransformMaxWH),
a.freeTransformMaxWH,function(a){a=new f.matFromArray(a,f.CV_8UC4);f.cvtColor(a,a,f.ColorConversionCodes.COLOR_RGBA2RGB.value,0);for(var e=new f.Mat.zeros(4,1,f.CV_32FC2),h=e.data32f(),k=0;k<d.length;++k){var l=d[k];h[2*k]=Math.round((l[0]+.5)*a.cols);h[2*k+1]=Math.round((l[1]+.5)*a.rows)}var n=h[2]-h[0],p=h[3]-h[1],l=h[4]-h[2],k=h[5]-h[3],t=h[6]-h[4],r=h[7]-h[5],q=h[0]-h[6],u=h[1]-h[7],h=Math.round(Math.max(Math.sqrt(n*n+p*p),Math.sqrt(t*t+r*r))),l=Math.round(Math.max(Math.sqrt(l*l+k*k),Math.sqrt(q*
q+u*u))),q=new f.Mat.zeros(4,1,f.CV_32FC2),k=q.data32f();k[2]=h;k[4]=h;k[5]=l;k[7]=l;k=f.getPerspectiveTransform(e,q);f.delMat(e);f.delMat(q);e=new f.Mat.zeros(l,h,f.CV_8UC3);q=new f.Scalar(0,255,0);f.warpPerspective(a,e,k,[e.rows,e.cols],f.InterpolationFlags.INTER_LINEAR.value,f.BORDER_CONSTANT,q);f.delMat(a);f.delMat(k);f.delMat(q);a=new ImageData(h,l);q=e.channels();n=e.data();for(p=k=0;k<n.length;k+=q,p+=4)a.data[p]=n[k],a.data[p+1]=n[k+1%q],a.data[p+2]=n[k+2%q],a.data[p+3]=255;f.delMat(e);c.width=
h;c.height=l;c.getContext("2d").putImageData(a,0,0);K.setImgStyleFit();v(c,function(a){g?B(b,[a]):(R.pushStack({srcBlob:a,saveFormat:"image/jpeg"}),R.updateCvsAsync(!0,!1,function(){Y([[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]]);F="perspect";m();B(b,[!0])}))},"image/jpeg")})}else B(b,[!1])};a.enterFreeTransformModeAsync=function(a){E&&KPainter.cvHasLoaded?(u=null,F="perspect",T(),setTimeout(function(){x.hideCropRect();R.updateCvsAsync(!0,!1,function(){Y([[-.5,-.5],[.5,-.5],[.5,.5],[-.5,.5]]);M.show();m();
R.needAlwaysTrueTransform=!0;B(a,[!0])})},0)):B(a,[!1])};a.exitFreeTransformModeAsync=function(b){"perspect"!=F?B(b,[!1]):(M.hide(),R.updateCvsAsync(!1,!1,function(){a.isAutoShowCropUI&&x.showCropRect();F=u=null;R.needAlwaysTrueTransform=!1;B(b,[!0])}))}})()};new function(){var b=D.children(".kPainterVideoMdl"),c=b.children(".kPainterVideo")[0],d=b.children(".kPainterBtnGrabVideo"),g=b.children(".kPainterBtnCloseVideo");a.videoSettings={video:{width:{ideal:2048},height:{ideal:2048},facingMode:{ideal:"environment"}}};
a.showVideo=function(d,g){navigator.mediaDevices.getUserMedia(g||a.videoSettings).then(function(a){c.onloadedmetadata=function(){c.onloadedmetadata=c.onerror=null;c.play();b.show();B(d,[!0])};c.onerror=function(){c.onloadedmetadata=c.onerror=null;B(d,[!1])};c.srcObject=a})["catch"](function(a){B(d,[!1]);setTimeout(function(){throw a;},0)})};a.grabVideo=function(b,d){var g=document.createElement("canvas");g.width=c.videoWidth;g.height=c.videoHeight;g.getContext("2d").drawImage(c,0,0);if(!b)return g;
a.addImageAsync(g,d)};a.hideVideo=function(){c.pause();for(var a=c.srcObject.getTracks(),d=0;d<a.length;++d)a[d].stop();b.hide()};d.on("click touchstart",function(){a.grabVideo(!0);a.hideVideo()});g.on("click touchstart",function(){a.hideVideo()})}};KPainter.cvFolder=void 0==KPainter.cvFolder?"js":KPainter.cvFolder;KPainter.cvHasLoaded=!1;KPainter._doCallbackNoBreak=function(b,a){if(b)try{b.apply(window,a||[])}catch(v){setTimeout(function(){throw v;},0)}};
KPainter.loadCvScriptAsync=function(b){KPainter.cvHasLoaded?KPainter._doCallbackNoBreak(b,[!0]):(KPainter._CVModule={cvFolder:KPainter.cvFolder,preRun:[],postRun:[],isRuntimeInitialized:!1,onRuntimeInitialized:function(){KPainter.cvHasLoaded=!0;console.log("Runtime is ready!");KPainter._doCallbackNoBreak(b,[!0]);b=null},onExit:function(){KPainter._doCallbackNoBreak(b,[!1]);b=null},onAbort:function(){KPainter._doCallbackNoBreak(b,[!1]);b=null},print:function(a){console.log(a)},printErr:function(a){console.log(a)},
setStatus:function(a){console.log(a)},totalDependencies:0},KPainter._CVModule.setStatus("Downloading..."),window.WebAssembly?$.ajax({type:"GET",url:KPainter.cvFolder+"/cv-wasm.js?v=20180921",dataType:"script",cache:!0,onerror:function(){KPainter._doCallbackNoBreak(b,[!1])}}):$.ajax({type:"GET",url:KPainter.cvFolder+"/cv.js?v=201800921",dataType:"script",cache:!0,onerror:function(){KPainter._doCallbackNoBreak(b,[!1])}}))};var MBC=KPainter;
